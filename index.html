<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Il2Cpp Metadata String Editor (Incremental Load)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 15px;
  }
  #fileInput {
    margin-bottom: 10px;
  }
  #progress {
    margin-bottom: 10px;
  }
  #stringsTable {
    border-collapse: collapse;
    width: 100%;
  }
  #stringsTable th, #stringsTable td {
    border: 1px solid #ccc;
    padding: 6px 8px;
    vertical-align: top;
  }
  textarea {
    width: 100%;
    font-family: monospace;
    height: 1.4em;
    resize: vertical;
  }
  #saveBtn {
    margin-top: 10px;
  }
</style>
</head>
<body>

<h2>Il2Cpp Metadata String Editor</h2>

<input type="file" id="fileInput" accept=".dat" />
<div id="progress">No file loaded</div>

<table id="stringsTable">
  <thead>
    <tr>
      <th>#</th>
      <th>Original String</th>
      <th>Modified String</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button id="saveBtn" disabled>Save Modified File</button>

<script>
const BATCH_SIZE = 50;

let arrayBuffer = null;
let dataView = null;
let stringLiteralCount = 0;
let stringLiteralOffsets = [];
let stringsData = []; // { original, modified }
let loadedCount = 0;

const fileInput = document.getElementById('fileInput');
const progress = document.getElementById('progress');
const tbody = document.querySelector('#stringsTable tbody');
const saveBtn = document.getElementById('saveBtn');

fileInput.addEventListener('change', handleFileLoad);
saveBtn.addEventListener('click', handleSave);

function handleFileLoad(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(evt) {
    arrayBuffer = evt.target.result;
    dataView = new DataView(arrayBuffer);
    resetState();
    try {
      parseMetadata();
    } catch (err) {
      alert('Failed to parse metadata: ' + err.message);
      return;
    }
    progress.textContent = `Parsing done. Found ${stringLiteralCount} strings. Loading...`;
    loadStringsBatch();
  };
  reader.readAsArrayBuffer(file);
}

function resetState() {
  stringLiteralCount = 0;
  stringLiteralOffsets = [];
  stringsData = [];
  loadedCount = 0;
  tbody.innerHTML = '';
  saveBtn.disabled = true;
}

function parseMetadata() {
  // --- REPLACE with your real parsing logic ---
  // Example parsing metadata header (adjust for your file format)
  // We'll pretend:
  // - At offset 0x00: version number (uint32)
  // - At offset 0x20: stringLiteralCount (uint32)
  // - At offset 0x100: string literal offsets table (array of uint32, each is offset to string data)
  
  // Basic checks:
  if (dataView.byteLength < 512) throw new Error("File too small to be valid metadata.");

  // Let's fake read stringLiteralCount at 0x20:
  stringLiteralCount = dataView.getUint32(0x20, true);

  if (stringLiteralCount <= 0 || stringLiteralCount > 1000000) {
    throw new Error("Invalid string literal count: " + stringLiteralCount);
  }

  // Read string literal offsets from 0x100 onwards, one uint32 each:
  stringLiteralOffsets = [];
  let offsetsTableStart = 0x100;
  for (let i = 0; i < stringLiteralCount; i++) {
    let offset = dataView.getUint32(offsetsTableStart + i * 4, true);
    if (offset === 0 || offset >= dataView.byteLength) {
      offset = 0; // Invalid offset - treat as empty string
    }
    stringLiteralOffsets.push(offset);
  }
  // --- End replace ---
}

function readIl2CppStringAt(offset) {
  if (offset === 0 || offset + 4 > dataView.byteLength) return '';
  const length = dataView.getUint32(offset, true);
  let chars = [];
  for (let i = 0; i < length; i++) {
    const charOffset = offset + 4 + i * 2;
    if (charOffset + 2 > dataView.byteLength) break;
    const charCode = dataView.getUint16(charOffset, true);
    if (charCode === 0) break;
    chars.push(String.fromCharCode(charCode));
  }
  return chars.join('');
}

function loadStringsBatch() {
  let batch = [];
  let count = 0;
  while (loadedCount < stringLiteralCount && count < BATCH_SIZE) {
    const offset = stringLiteralOffsets[loadedCount];
    const originalStr = readIl2CppStringAt(offset);
    const entry = { index: loadedCount, original: originalStr, modified: originalStr };
    stringsData[loadedCount] = entry;
    batch.push(entry);
    loadedCount++;
    count++;
  }
  appendStringsToTable(batch);
  progress.textContent = `Loaded strings: ${loadedCount} / ${stringLiteralCount}`;

  if (loadedCount < stringLiteralCount) {
    setTimeout(loadStringsBatch, 0);
  } else {
    progress.textContent = `All ${stringLiteralCount} strings loaded. You can edit and save now.`;
    saveBtn.disabled = false;
  }
}

function appendStringsToTable(batch) {
  for (const item of batch) {
    const tr = document.createElement('tr');

    const tdIndex = document.createElement('td');
    tdIndex.textContent = item.index;
    tr.appendChild(tdIndex);

    const tdOriginal = document.createElement('td');
    tdOriginal.textContent = item.original;
    tr.appendChild(tdOriginal);

    const tdModified = document.createElement('td');
    const ta = document.createElement('textarea');
    ta.value = item.modified;
    ta.dataset.index = item.index;
    ta.addEventListener('input', (e) => {
      const idx = parseInt(e.target.dataset.index);
      stringsData[idx].modified = e.target.value;
    });
    tdModified.appendChild(ta);
    tr.appendChild(tdModified);

    tbody.appendChild(tr);
  }
}

function handleSave() {
  if (!arrayBuffer) return;
  // Here you should implement your saving logic:
  // - Compare stringsData.modified vs original
  // - Update arrayBuffer with modified strings either in place or appended
  // - Update metadata offsets accordingly

  alert("Save functionality not implemented yet â€” you need to implement it based on your file format.");
}

</script>

</body>
</html>
