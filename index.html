<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ugly Metadata Editor with Search</title>
<style>
  body {
    font-family: monospace;
    background: white;
    color: black;
    padding: 10px;
  }
  #file-input {
    font-size: 20px;
    margin-bottom: 10px;
  }
  #search-input {
    font-size: 20px;
    width: 100%;
    margin-bottom: 10px;
    border: 2px solid red;
    padding: 5px;
    background: yellow;
    color: black;
  }
  #string-list {
    max-height: 400px;
    overflow-y: scroll;
    border: 2px solid black;
    padding: 5px;
  }
  .string-item {
    margin-bottom: 8px;
  }
  .string-label {
    font-weight: bold;
  }
  .string-input {
    font-family: monospace;
    font-size: 16px;
    width: 100%;
    box-sizing: border-box;
  }
</style>
</head>
<body>

<input type="file" id="file-input" accept=".dat" />
<input type="text" id="search-input" placeholder="Type here to search strings..." />

<div id="string-list"></div>

<script>
const fileInput = document.getElementById('file-input');
const searchInput = document.getElementById('search-input');
const stringList = document.getElementById('string-list');

let allEntries = [];

fileInput.addEventListener('change', () => {
  const file = fileInput.files[0];
  if (!file) return;

  stringList.innerHTML = '';
  allEntries = [];

  file.arrayBuffer().then(buf => {
    const bytes = new Uint8Array(buf);
    const decoder = new TextDecoder('ascii');

    let i = 0;
    while (i < bytes.length) {
      if (bytes[i] >= 0x20 && bytes[i] <= 0x7E) {
        let start = i;
        while (i < bytes.length && bytes[i] >= 0x20 && bytes[i] <= 0x7E) i++;
        if (i < bytes.length && bytes[i] === 0x00) {
          const str = decoder.decode(bytes.subarray(start, i));
          if (str.length >= 3) {
            allEntries.push({ offset: start, original: str, current: str });
          }
          i++;
        } else {
          i++;
        }
      } else {
        i++;
      }
    }
    renderEntries(allEntries);
  });
});

function renderEntries(entries) {
  stringList.innerHTML = '';
  entries.forEach((e, idx) => {
    const div = document.createElement('div');
    div.className = 'string-item';

    const label = document.createElement('div');
    label.className = 'string-label';
    label.textContent = `[${idx}] (0x${e.offset.toString(16)})`;

    const input = document.createElement('input');
    input.className = 'string-input';
    input.type = 'text';
    input.value = e.current;
    input.maxLength = e.original.length;
    input.addEventListener('input', () => {
      if (input.value.length <= e.original.length) {
        e.current = input.value;
      } else {
        input.value = e.current;
      }
    });

    div.appendChild(label);
    div.appendChild(input);
    stringList.appendChild(div);
  });
}

searchInput.addEventListener('input', () => {
  const query = searchInput.value.toLowerCase();
  const children = Array.from(stringList.children);
  children.forEach((div, i) => {
    const e = allEntries[i];
    if (!query || e.current.toLowerCase().includes(query)) {
      div.style.display = '';
    } else {
      div.style.display = 'none';
    }
  });
});
</script>

</body>
</html>
