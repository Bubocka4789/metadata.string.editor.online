import sys
import re
from dataclasses import dataclass
from pathlib import Path

PRINTABLE_RE = re.compile(rb"[\x20-\x7E]+\x00")

@dataclass
class StringEntry:
    offset: int
    original: str
    current: str

    @property
    def length(self) -> int:
        return len(self.original)

def load_metadata(path: Path):
    with open(path, "rb") as f:
        data = f.read()
    binary = bytearray(data)
    entries = []
    for match in PRINTABLE_RE.finditer(data):
        string_bytes = match.group(0)[:-1]
        try:
            string = string_bytes.decode("ascii")
        except UnicodeDecodeError:
            continue
        offset = match.start()
        entries.append(StringEntry(offset, string, string))
    return binary, entries

def save_metadata(path: Path, binary: bytearray, entries):
    for entry in entries:
        if entry.current != entry.original:
            new_bytes = entry.current.encode("ascii")
            new_bytes += b"\x00" * (entry.length - len(entry.current))
            binary[entry.offset : entry.offset + entry.length] = new_bytes
    with open(path, "wb") as f:
        f.write(binary)

def main():
    import threading

    if len(sys.argv) < 2:
        print("Usage: python metadata_string_editor.py <metadata_file>")
        return

    path = Path(sys.argv[1])
    if not path.exists():
        print(f"File not found: {path}")
        return

    print("Loading metadata file, please wait...\n")
    binary, entries = load_metadata(path)
    print(f"Loaded {len(entries)} strings from {path.name}\n")

    def run_editor():
        for idx, entry in enumerate(entries):
            print(f"[{idx}] {entry.original}")

        print("\nEnter the index of the string to edit (or 'q' to quit):")
        while True:
            cmd = input("> ").strip()
            if cmd.lower() == 'q':
                break
            if not cmd.isdigit():
                print("Invalid input. Enter a number or 'q'.")
                continue
            i = int(cmd)
            if i < 0 or i >= len(entries):
                print("Index out of range.")
                continue
            entry = entries[i]
            print(f"Original: {entry.original}")
            new_value = input(f"New (max {entry.length} chars): ").strip()
            if len(new_value) > entry.length:
                print("Too long.")
                continue
            entry.current = new_value

        out_path = path.with_name(path.stem + "_patched.dat")
        save_metadata(out_path, binary, entries)
        print(f"Saved patched metadata to {out_path}")

    editor_thread = threading.Thread(target=run_editor)
    editor_thread.start()
    editor_thread.join()

if __name__ == "__main__":
    main()
