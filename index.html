<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Il2Cpp Metadata String Editor</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    textarea { width: 100%; height: 80px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    td, th { border: 1px solid #ccc; padding: 5px; }
    .modified { background-color: #ffe4b2; }
    .controls { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Il2Cpp Metadata String Editor (v29+ Supported)</h1>
  <input type="file" id="fileInput" />
  <div class="controls">
    <button id="saveDat" disabled>ðŸ’¾ Save .dat</button>
    <button id="saveIde" disabled>ðŸ’¾ Save .ide</button>
  </div>
  <table id="stringTable">
    <thead>
      <tr><th>#</th><th>Original</th><th>Modified</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    const fileInput = document.getElementById('fileInput');
    const tableBody = document.querySelector('#stringTable tbody');
    const saveDatBtn = document.getElementById('saveDat');
    const saveIdeBtn = document.getElementById('saveIde');

    let originalFile;
    let modifiedStrings = [];

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;

      originalFile = file;
      tableBody.innerHTML = '';
      modifiedStrings = [];

      const reader = new FileReader();
      reader.onload = function (e) {
        const buffer = new Uint8Array(e.target.result);
        extractStringsLive(buffer);
      };
      reader.readAsArrayBuffer(file);
    });

    function extractStringsLive(buffer) {
      const minLen = 4;
      const strings = [];
      let str = '';
      let offset = 0;
      let shown = 0;

      function isPrintable(c) {
        return c >= 0x20 && c <= 0x7E;
      }

      function flushString() {
        if (str.length >= minLen) {
          const index = strings.length;
          strings.push(str);
          modifiedStrings.push(str);
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${index}</td>
            <td>${str}</td>
            <td><input data-idx="${index}" value="${str}" /></td>`;
          tableBody.appendChild(tr);
        }
        str = '';
      }

      const batchSize = 100000;
      const chunk = () => {
        for (let i = offset; i < offset + batchSize && i < buffer.length; i++) {
          const c = buffer[i];
          if (isPrintable(c)) {
            str += String.fromCharCode(c);
          } else {
            flushString();
          }
        }
        flushString();
        offset += batchSize;
        if (offset < buffer.length) {
          requestAnimationFrame(chunk);
        } else {
          saveDatBtn.disabled = false;
          saveIdeBtn.disabled = false;
        }
      };
      chunk();
    }

    tableBody.addEventListener('input', (e) => {
      if (e.target.tagName === 'INPUT') {
        const idx = +e.target.dataset.idx;
        modifiedStrings[idx] = e.target.value;
        e.target.closest('tr').classList.add('modified');
      }
    });

    saveIdeBtn.addEventListener('click', () => {
      const lines = [];
      for (let i = 0; i < modifiedStrings.length; i++) {
        if (modifiedStrings[i] !== null && modifiedStrings[i] !== '') {
          lines.push(modifiedStrings[i]);
        }
      }
      const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'storage.ide';
      a.click();
      URL.revokeObjectURL(url);
    });

    saveDatBtn.addEventListener('click', () => {
      const reader = new FileReader();
      reader.onload = function (e) {
        const original = new Uint8Array(e.target.result);
        const encoder = new TextEncoder();
        const modified = new Uint8Array(original);

        const addedStrings = [];
        const baseOffset = original.length;
        let writePtr = baseOffset;

        for (let i = 0; i < modifiedStrings.length; i++) {
          const modStr = modifiedStrings[i];
          const origStr = tableBody.rows[i].cells[1].textContent;
          if (modStr !== origStr) {
            const encoded = encoder.encode(modStr + '\0');
            addedStrings.push(...encoded);
          }
        }

        const finalBuffer = new Uint8Array(original.length + addedStrings.length);
        finalBuffer.set(original, 0);
        finalBuffer.set(addedStrings, original.length);

        const blob = new Blob([finalBuffer], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'global-metadata-modified.dat';
        a.click();
        URL.revokeObjectURL(url);
      };
      reader.readAsArrayBuffer(originalFile);
    });
  </script>
</body>
</html>
