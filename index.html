<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Metadata String Editor</title>
  <style>
    body {
      font-family: sans-serif;
      background: #121212;
      color: #eee;
      margin: 0;
      padding: 1rem;
    }
    h1 { text-align: center; }
    #controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 1rem;
    }
    input, button {
      padding: 0.5rem;
      background: #222;
      border: 1px solid #555;
      color: #fff;
      border-radius: 4px;
    }
    #list {
      max-height: 70vh;
      overflow-y: auto;
      border: 1px solid #333;
      padding: 1rem;
      background: #1e1e1e;
    }
    .entry {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 0.75rem;
      border-bottom: 1px solid #333;
      padding-bottom: 0.5rem;
    }
    .entry input {
      width: 100%;
      font-family: monospace;
      margin-top: 0.25rem;
    }
    .label {
      flex-basis: 100%;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
      color: #90caf9;
    }
    .col {
      flex: 1;
      margin-right: 1rem;
    }
  </style>
</head>
<body>
  <h1>Metadata String Editor</h1>
  <div id="controls">
    <input type="file" id="fileInput" accept=".dat">
    <input type="text" id="searchInput" placeholder="Search (case-sensitive)">
    <button id="downloadBtn">Download</button>
  </div>
  <div id="list"></div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const list = document.getElementById('list');
    const searchInput = document.getElementById('searchInput');
    const downloadBtn = document.getElementById('downloadBtn');

    let entries = [];
    let originalBuffer;

    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0];
      if (!file) return;

      const arrayBuffer = await file.arrayBuffer();
      originalBuffer = new Uint8Array(arrayBuffer);
      entries = extractStringsFromMetadata(originalBuffer);
      renderEntries(entries);
    });

    function extractStringsFromMetadata(buf) {
      const dv = new DataView(buf.buffer);
      const count = dv.getUint32(0x0010, true); // string literal count
      const literalOffset = dv.getUint32(0x0014, true); // literal data start
      const metadataSize = dv.getUint32(0x0004, true);

      const strings = [];
      for (let i = 0; i < count; i++) {
        const offset = dv.getUint32(0x0018 + i * 4, true);
        let str = '';
        let ptr = offset;

        while (ptr < buf.length && buf[ptr] !== 0) {
          str += String.fromCharCode(buf[ptr]);
          ptr++;
        }

        strings.push({
          index: i,
          offset,
          original: str,
          current: str
        });
      }
      return strings;
    }

    function renderEntries(data) {
      list.innerHTML = '';
      const fragment = document.createDocumentFragment();

      for (const entry of data) {
        const container = document.createElement('div');
        container.className = 'entry';

        const label = document.createElement('div');
        label.className = 'label';
        label.textContent = `[Offset 0x${entry.offset.toString(16)}]`;

        const originalCol = document.createElement('div');
        originalCol.className = 'col';
        const origLabel = document.createElement('label');
        origLabel.textContent = 'Original';
        const origInput = document.createElement('input');
        origInput.type = 'text';
        origInput.value = entry.original;
        origInput.readOnly = true;
        originalCol.appendChild(origLabel);
        originalCol.appendChild(origInput);

        const modCol = document.createElement('div');
        modCol.className = 'col';
        const modLabel = document.createElement('label');
        modLabel.textContent = 'Modified';
        const modInput = document.createElement('input');
        modInput.type = 'text';
        modInput.value = entry.current;
        modInput.maxLength = entry.original.length;
        modInput.addEventListener('input', () => {
          modInput.value = modInput.value.replace(/[^\x20-\x7E]/g, '').slice(0, entry.original.length);
          entry.current = modInput.value;
        });
        modCol.appendChild(modLabel);
        modCol.appendChild(modInput);

        container.appendChild(label);
        container.appendChild(originalCol);
        container.appendChild(modCol);
        fragment.appendChild(container);
      }

      list.appendChild(fragment);
    }

    searchInput.addEventListener('input', () => {
      const query = searchInput.value;
      if (!query) return renderEntries(entries);
      const filtered = entries.filter(e => e.original.includes(query) || e.current.includes(query));
      renderEntries(filtered);
    });

    downloadBtn.addEventListener('click', () => {
      if (!originalBuffer || entries.length === 0) return;

      const updated = new Uint8Array(originalBuffer);
      for (const entry of entries) {
        const enc = new TextEncoder().encode(entry.current.padEnd(entry.original.length, '\0'));
        updated.set(enc.slice(0, entry.original.length), entry.offset);
      }

      const blob = new Blob([updated], { type: 'application/octet-stream' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'modified-metadata.dat';
      a.click();
      URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
