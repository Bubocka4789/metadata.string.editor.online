<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simple String-based Binary Editor</title>
<style>
  body { font-family: monospace; margin: 1em; }
  #strings { max-height: 70vh; overflow-y: auto; border: 1px solid #ccc; padding: 0.5em; }
  .string-item { margin-bottom: 1em; }
  .label { font-weight: bold; margin-bottom: 0.2em; }
  textarea { width: 100%; height: 3em; font-family: monospace; }
  #search { width: 100%; padding: 0.5em; margin-bottom: 1em; font-size: 1em; }
  button { margin-top: 1em; padding: 0.5em 1em; font-size: 1em; }
</style>
</head>
<body>

<h1>Simple String-based Binary Editor</h1>
<input id="fileInput" type="file" />
<input id="search" placeholder="Search strings..." />
<div id="strings"></div>
<button id="saveBtn" disabled>Save Modified File</button>

<script>
(() => {
  let buffer = null;
  let entries = [];

  const fileInput = document.getElementById('fileInput');
  const stringsDiv = document.getElementById('strings');
  const searchInput = document.getElementById('search');
  const saveBtn = document.getElementById('saveBtn');

  // Extract all ASCII strings >= 3 chars (printable chars only)
  function extractStrings(buf) {
    entries = [];
    let current = [];
    let start = null;
    for (let i = 0; i < buf.length; i++) {
      const c = buf[i];
      if (c >= 32 && c <= 126) {
        if (start === null) start = i;
        current.push(String.fromCharCode(c));
      } else {
        if (current.length >= 3) {
          entries.push({ offset: start, length: current.length, text: current.join('') });
        }
        start = null;
        current = [];
      }
    }
    // Handle last string
    if (current.length >= 3) {
      entries.push({ offset: start, length: current.length, text: current.join('') });
    }
  }

  // Render strings to DOM, filtering by search text
  function renderStrings(filter = '') {
    stringsDiv.innerHTML = '';
    const filtered = entries.filter(e => e.text.toLowerCase().includes(filter.toLowerCase()));
    for (const entry of filtered) {
      const div = document.createElement('div');
      div.className = 'string-item';

      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = `Offset 0x${entry.offset.toString(16)} - Length ${entry.length}`;

      const textarea = document.createElement('textarea');
      textarea.value = entry.text;
      textarea.addEventListener('input', () => {
        const newText = textarea.value;
        if (newText.length > entry.length) {
          alert(`Text too long! Max length: ${entry.length}`);
          textarea.value = entry.text; // revert
          return;
        }
        // Update buffer bytes at entry.offset
        for (let i = 0; i < entry.length; i++) {
          const code = i < newText.length ? newText.charCodeAt(i) : 0x20; // pad with spaces if shorter
          buffer[entry.offset + i] = code;
        }
        entry.text = textarea.value;
      });

      div.appendChild(label);
      div.appendChild(textarea);
      stringsDiv.appendChild(div);
    }
  }

  fileInput.addEventListener('change', async () => {
    const file = fileInput.files[0];
    if (!file) return;

    const arrayBuffer = await file.arrayBuffer();
    buffer = new Uint8Array(arrayBuffer);

    extractStrings(buffer);
    renderStrings();
    saveBtn.disabled = false;
  });

  searchInput.addEventListener('input', () => {
    renderStrings(searchInput.value);
  });

  saveBtn.addEventListener('click', () => {
    if (!buffer) return;
    const blob = new Blob([buffer], {type: 'application/octet-stream'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'modified_file.dat';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });
})();
</script>

</body>
</html>
